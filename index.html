<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GPA Master</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 10v6M2 10l10-5 10 5-10 5z'/%3E%3Cpath d='M6 12v5c3 3 9 3 12 0v-5'/%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Lexend', 'sans-serif'],
            },
            colors: {
              primary: {
                DEFAULT: '#3b82f6',
                hover: '#2563eb',
              },
            },
            keyframes: {
                shimmer: {
                    '0%': { backgroundPosition: '200% 0' },
                    '100%': { backgroundPosition: '-200% 0' }
                }
            },
            animation: {
                shimmer: 'shimmer 3s linear infinite',
            }
          }
        }
      }
    </script>

    <style>
      body {
        font-family: 'Lexend', sans-serif;
        background-color: #f0f4f8;
        color: #1e293b;
        overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
      }

      /* Hide number input spinners */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      input[type=number] {
        -moz-appearance: textfield;
      }

      /* Animated Background Blobs */
      .liquid-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        background: radial-gradient(circle at 50% 50%, #f1f5f9, #dbeafe);
        transform: translateZ(0); /* Hardware Acceleration Hint */
      }
      .liquid-blob {
        position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.7;
        animation: blobFloat 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        mix-blend-mode: multiply;
        will-change: transform; /* Hint for browser optimization */
      }
      @keyframes blobFloat {
        0% { transform: translate(0, 0) scale(1) rotate(0deg); }
        50% { transform: translate(30px, -30px) scale(1.1) rotate(10deg); }
        100% { transform: translate(-20px, 20px) scale(0.9) rotate(-5deg); }
      }

      /* Noise Texture */
      .noise-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.04;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      }

      /* --- LIQUID GLASS STYLES --- */
      
      .glass-panel {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-top: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
      }

      .glass-card {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.2));
        backdrop-filter: blur(50px) saturate(160%);
        -webkit-backdrop-filter: blur(50px) saturate(160%);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-top: 1px solid rgba(255, 255, 255, 0.9);
        border-left: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 
            0 20px 50px -12px rgba(0, 0, 0, 0.1), 
            inset 0 0 0 2px rgba(255, 255, 255, 0.1); /* Glossy ring */
        position: relative; 
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s;
        border-radius: 2.5rem; /* Enhanced rounding */
      }
      
      .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 
            0 25px 60px -12px rgba(59, 130, 246, 0.15), 
            inset 0 0 0 2px rgba(255, 255, 255, 0.3);
      }

      /* Inputs: Deep liquid recess */
      .glass-input {
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-top: 1px solid rgba(0, 0, 0, 0.03); 
        box-shadow: inset 2px 2px 6px rgba(0, 0, 0, 0.03), inset -1px -1px 4px rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(15px);
        color: #1e293b;
        transition: all 0.3s ease;
        border-radius: 1.5rem; /* Very rounded */
      }
      .glass-input:focus {
        background: rgba(255, 255, 255, 0.85);
        border-color: rgba(59, 130, 246, 0.5);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), inset 0 0 0 1px rgba(255,255,255,1);
        outline: none;
        transform: translateY(-1px);
      }

      /* Buttons: Liquid Bubble */
      .glass-button {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-top: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 9999px; /* Pill shape */
        box-shadow: 
            0 6px 20px rgba(37, 99, 235, 0.35), 
            inset 0 2px 0 rgba(255, 255, 255, 0.3),
            inset 0 -2px 0 rgba(0, 0, 0, 0.1);
        color: white;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        text-shadow: 0 1px 2px rgba(0,0,0,0.15);
      }
      .glass-button:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 30px rgba(37, 99, 235, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.4);
        filter: brightness(1.1);
      }
      .glass-button:active { transform: translateY(-1px) scale(0.98); }

      .glass-button-secondary {
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.6);
        color: #3b82f6;
        transition: all 0.3s;
        border-radius: 1.5rem;
      }
      .glass-button-secondary:hover {
        background: rgba(255, 255, 255, 0.75);
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar { display: none; }
      
      /* Row Animation */
      .table-row-anim { transition: all 0.2s; border-radius: 1rem; }
      .table-row-anim:hover { background-color: rgba(255, 255, 255, 0.5); transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }

      /* Sim Mode */
      .sim-mode-active .glass-card { 
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), rgba(245, 243, 255, 0.5));
        border-color: rgba(167, 139, 250, 0.4); 
        box-shadow: 0 20px 50px -10px rgba(139, 92, 246, 0.2); 
      }
      .sim-input {
        background: rgba(255, 255, 255, 0.6);
        border: 1px dashed #a78bfa;
        color: #7c3aed; font-weight: 700; text-align: center; border-radius: 0.75rem; width: 100%; min-width: 50px; padding: 6px;
        transition: all 0.2s;
      }
      .sim-input:focus { background: #fff; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); transform: scale(1.05); border-style: solid; }

      @keyframes fadeInScale { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
      .animate-enter { animation: fadeInScale 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

      /* ========================================= */
      /* MOBILE OPTIMIZATION & PERFORMANCE FIXES */
      /* ========================================= */
      @media (max-width: 768px) {
        /* 1. Disable Noise Effect (High CPU usage) */
        .noise-bg { display: none !important; }

        /* 2. Reduce Blob details (High GPU fill-rate) */
        .liquid-blob {
            filter: blur(40px) !important; /* Reduced blur radius */
            opacity: 0.5 !important;
        }

        /* 3. Disable Backdrop Filter (The main cause of lag on mobile) */
        .glass-panel, 
        .glass-card, 
        .glass-input, 
        .glass-button, 
        .glass-button-secondary,
        #stats-modal .bg-white\/80 {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            /* Fallback to a solid/semi-solid color */
            background: rgba(255, 255, 255, 0.94) !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.9) !important;
        }

        /* 4. Optimize Interactions */
        .glass-card:hover, 
        .table-row-anim:hover,
        .glass-button:hover,
        .glass-button-secondary:hover {
            transform: none !important; /* Disable scale/translate on hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05) !important;
        }

        /* 5. Input optimization */
        .glass-input:focus {
            transform: none !important;
            background: #ffffff !important;
        }

        /* 6. Sim Mode Specifics */
        .sim-mode-active .glass-card {
             background: #fdfbff !important; /* Solid color for sim mode */
        }
      }

    </style>
</head>
<body>

    <div class="liquid-container">
        <div class="liquid-blob w-[800px] h-[800px] bg-[#60a5fa] top-[-20%] left-[-10%] opacity-30 filter blur-[100px]"></div>
        <div class="liquid-blob w-[700px] h-[700px] bg-[#a78bfa] top-[30%] right-[-20%] opacity-25 filter blur-[110px]" style="animation-duration: 30s; animation-delay: -5s"></div>
        <div class="liquid-blob w-[600px] h-[600px] bg-[#f472b6] bottom-[-15%] left-[10%] opacity-20 filter blur-[120px]" style="animation-duration: 25s; animation-delay: -10s"></div>
        <div class="liquid-blob w-[500px] h-[500px] bg-[#22d3ee] bottom-[10%] right-[25%] opacity-20 filter blur-[90px]" style="animation-duration: 35s; animation-delay: -15s"></div>
    </div>
    
    <div class="noise-bg"></div>

    <div class="relative min-h-screen flex flex-col font-sans overflow-hidden z-10" id="app-container">
        
        <header class="sticky top-0 z-50 transition-all pt-3 px-3 lg:pt-6 lg:px-8">
            <div class="glass-panel rounded-[2rem] mx-auto max-w-[1200px] shadow-lg shadow-blue-900/5">
                <div class="flex flex-wrap md:flex-nowrap items-center justify-between gap-y-3 px-6 py-4 relative z-50">
                    
                    <div class="flex items-center gap-3 shrink-0 z-20 order-1 group cursor-default">
                        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-gradient-to-tr from-blue-500 to-cyan-500 text-white shadow-xl shadow-blue-500/30 ring-2 ring-white/50 transition-transform group-hover:rotate-12 group-hover:scale-105">
                            <i data-lucide="graduation-cap" class="h-6 w-6"></i>
                        </div>
                        <h2 class="hidden sm:block text-slate-800 text-2xl font-black tracking-tight drop-shadow-sm">GPA <span class="text-blue-600">Master</span></h2>
                    </div>

                    <div class="order-3 md:order-2 w-full md:w-auto flex justify-center z-10">
                        <div class="flex bg-white/30 rounded-full p-1.5 border border-white/40 backdrop-blur-xl shadow-[inset_0_2px_4px_rgba(0,0,0,0.05)] w-full md:w-auto justify-center">
                            <button onclick="switchTab('calculator')" id="nav-calculator" class="flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 bg-white shadow-md text-blue-600 ring-1 ring-black/5">
                                Tính điểm
                            </button>
                            <button onclick="switchTab('goal')" id="nav-goal" class="flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 text-slate-500 hover:text-slate-800 hover:bg-white/40">
                                Mục tiêu
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 sm:gap-5 relative z-20 order-2 md:order-3 justify-end flex-1 md:flex-none">
                         <div class="flex items-center gap-2 mr-1 sm:mr-2 bg-white/40 rounded-full pl-1.5 pr-3 sm:pr-4 py-1.5 border border-white/40 shadow-sm backdrop-blur-sm transition-colors hover:bg-white/60">
                            <label class="inline-flex items-center cursor-pointer relative">
                                <input type="checkbox" id="sim-toggle" class="sr-only peer" onchange="toggleSimulation()">
                                <div class="w-10 h-6 sm:w-12 sm:h-7 bg-slate-200/80 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:border-gray-200 after:border after:rounded-full after:h-[18px] after:w-[18px] sm:after:h-[22px] sm:after:w-[22px] after:transition-all after:shadow-sm peer-checked:bg-purple-500 border border-slate-300/50 shadow-inner"></div>
                                <span class="ml-2.5 text-[11px] sm:text-xs font-bold text-slate-600 peer-checked:text-purple-700 transition-colors select-none whitespace-nowrap">Dự tính</span>
                            </label>
                        </div>

                        <div class="hidden lg:flex flex-col items-end">
                            <span id="save-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">OFFLINE</span>
                        </div>
                        
                        <div class="flex items-center gap-2 bg-white/40 hover:bg-white/60 rounded-2xl px-3 sm:px-4 py-2.5 border border-white/50 shadow-sm backdrop-blur-md transition-all focus-within:bg-white/90 focus-within:ring-4 focus-within:ring-blue-100/50 focus-within:border-blue-300 group/input">
                            <div class="relative">
                                <i data-lucide="user-circle-2" class="w-6 h-6 text-slate-600 group-focus-within/input:text-blue-600 transition-colors"></i>
                                <div id="status-dot" class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full bg-slate-400 ring-2 ring-white"></div>
                            </div>
                            <input 
                                id="student-id" 
                                type="text" 
                                placeholder="MSSV" 
                                onchange="handleStudentIdChange(this.value)" 
                                onkeydown="if(event.key === 'Enter') this.blur()"
                                class="bg-transparent border-none p-0 text-sm font-bold text-slate-700 placeholder-slate-400 w-20 sm:w-28 focus:ring-0 focus:outline-none uppercase tracking-wide text-center sm:text-left transition-all"
                            >
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow w-full max-w-[1200px] mx-auto px-4 py-6 sm:py-8 z-10 relative">
            
            <div id="loading-skeleton" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8 animate-pulse">
                <div class="lg:col-span-8 space-y-6">
                    <div class="h-64 rounded-[3rem] bg-white/30 border border-white/30 backdrop-blur-sm"></div>
                    <div class="h-96 rounded-[3rem] bg-white/30 border border-white/30 backdrop-blur-sm"></div>
                </div>
                <div class="lg:col-span-4">
                    <div class="h-80 rounded-[3rem] bg-white/30 border border-white/30 backdrop-blur-sm"></div>
                </div>
            </div>

            <div id="main-content" class="block">
                <div id="tab-content-calculator" class="tab-content animate-enter">
                    <div class="grid grid-cols-1 gap-6 lg:gap-8 lg:grid-cols-12 items-start">
                        
                        <div class="flex flex-col gap-6 lg:col-span-8 order-1 lg:order-1">

                            <div class="glass-card p-6 sm:p-8 lg:p-10">
                                <h3 class="mb-8 flex items-center gap-4 text-xl font-bold text-slate-800">
                                    <div class="bg-blue-500/10 p-3 rounded-2xl text-blue-600 ring-1 ring-blue-500/20 shadow-sm backdrop-blur-sm">
                                        <i data-lucide="plus" class="w-6 h-6"></i>
                                    </div>
                                    Nhập thông tin môn học
                                </h3>
                                
                                <div class="flex flex-col gap-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div class="md:col-span-2 flex flex-col gap-2.5">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-500 ml-2">Tên môn học</label>
                                            <input id="input-name" type="text" placeholder="Ví dụ: Đại Số Tuyến Tính" class="glass-input h-14 w-full px-6 text-base font-semibold placeholder:font-normal placeholder:text-slate-400/80" onkeydown="if(event.key === 'Enter') document.getElementById('input-credits').focus()">
                                        </div>
                                        <div class="flex flex-col gap-2.5">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-500 ml-2">Học kỳ</label>
                                            <div class="relative group">
                                                <select id="input-semester" class="glass-input h-14 w-full px-6 text-base font-semibold appearance-none cursor-pointer hover:bg-white/50 transition-colors text-center outline-none focus:ring-0">
                                                    </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-6">
                                        <div class="flex flex-col gap-2.5">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-500 ml-2">Số tín chỉ</label>
                                            <input id="input-credits" type="number" placeholder="3" min="1" max="10" inputmode="numeric" class="glass-input h-14 w-full px-6 text-base font-semibold placeholder:font-normal placeholder:text-slate-400/80 text-center" onkeydown="if(event.key === 'Enter') document.getElementById('input-score').focus()">
                                        </div>
                                        <div class="flex flex-col gap-2.5">
                                            <label class="text-xs font-bold uppercase tracking-wider text-slate-500 ml-2">Điểm (hệ 10)</label>
                                            <input id="input-score" type="text" placeholder="8.5" inputmode="decimal" class="glass-input h-14 w-full px-6 text-base font-semibold placeholder:font-normal placeholder:text-slate-400/80 text-center" onkeydown="if(event.key === 'Enter') addSubject()">
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4 pt-3">
                                        <button id="btn-accumulate" onclick="toggleNewAccumulate()" class="glass-button-secondary flex items-center gap-2.5 h-14 px-6 active:scale-95 transition-all" title="Tích lũy vào GPA?">
                                            <i data-lucide="check-circle-2" class="h-5 w-5 shrink-0"></i>
                                            <span class="text-sm font-bold whitespace-nowrap">Tích lũy</span>
                                        </button>
                                        
                                        <button onclick="addSubject()" id="btn-add-main" class="glass-button flex-1 h-14 flex items-center justify-center gap-2 text-base font-bold active:scale-95 shadow-blue-500/30">
                                            <i data-lucide="plus" class="h-6 w-6"></i>
                                            <span class="hidden sm:inline">Thêm môn học</span>
                                            <span class="inline sm:hidden">Thêm</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col overflow-hidden glass-card transition-colors duration-500" id="list-card">
                                <div class="flex items-center justify-between border-b border-white/40 bg-white/20 px-8 py-6 backdrop-blur-xl">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                                        Danh sách môn
                                        <span id="sim-badge" class="hidden text-[10px] bg-purple-100/90 text-purple-700 px-3 py-1 rounded-lg border border-purple-200 uppercase tracking-wider animate-pulse font-extrabold shadow-sm">Dự tính</span>
                                    </h3>
                                    <button onclick="deleteAllSubjects()" id="btn-delete-all" class="flex items-center gap-2 text-xs font-bold text-red-500 hover:text-red-600 transition-colors px-4 py-2 rounded-xl hover:bg-red-50/50 active:bg-red-100 ring-1 ring-transparent hover:ring-red-200/50 backdrop-blur-sm">
                                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        <span class="hidden sm:inline">Xóa tất cả</span>
                                    </button>
                                </div>
                                <div class="overflow-x-auto custom-scrollbar pb-2">
                                    <table class="w-full border-collapse text-left min-w-[650px] md:min-w-0">
                                        <thead class="bg-white/10 text-slate-500 border-b border-white/20">
                                            <tr>
                                                <th class="px-5 py-5 text-xs font-bold uppercase tracking-wider hidden sm:table-cell pl-8 opacity-70">STT</th>
                                                <th class="px-5 py-5 text-xs font-bold uppercase tracking-wider w-1/3 min-w-[140px] opacity-70">Môn học</th>
                                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider opacity-70">TC</th>
                                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider opacity-70">Tích lũy</th>
                                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider opacity-70">Điểm (10)</th>
                                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider text-blue-600">Điểm (4)</th>
                                                <th class="px-5 py-5 text-center text-xs font-bold uppercase tracking-wider opacity-70">Chữ</th>
                                                <th class="px-5 py-5 text-right text-xs font-bold uppercase tracking-wider pr-8 opacity-70">Xóa</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subject-list" class="divide-y divide-white/30"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col gap-6 lg:col-span-4 order-2 lg:order-2 lg:sticky lg:top-28">
                            
                            <div class="group/stats relative overflow-hidden rounded-[3rem] p-8 text-white shadow-2xl shadow-blue-600/20 border border-white/40 transition-all hover:translate-y-[-6px] duration-700">
                                 <div class="absolute inset-0 bg-gradient-to-br from-blue-600/90 via-indigo-600/90 to-purple-600/90 transition-all duration-700 backdrop-blur-2xl" id="stats-bg"></div>
                                 <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 mix-blend-overlay"></div>
                                 
                                 <div class="absolute -right-20 -top-20 h-64 w-64 rounded-full bg-cyan-400 blur-[90px] opacity-40 group-hover/stats:opacity-60 transition-opacity duration-1000"></div>
                                 <div class="absolute -left-20 -bottom-20 h-56 w-56 rounded-full bg-pink-500 blur-[90px] opacity-40 group-hover/stats:opacity-60 transition-opacity duration-1000 delay-100"></div>

                                 <div class="relative z-10">
                                     <h3 class="text-xl font-medium opacity-95 tracking-wide flex items-center justify-between mb-8">
                                         Kết quả học tập
                                         <button onclick="openStatsModal()" class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 transition-all border border-white/30 shadow-lg backdrop-blur-md group/btn hover:scale-105 active:scale-95">
                                             <i data-lucide="bar-chart-2" class="h-4 w-4 text-white"></i>
                                             <span class="text-xs font-bold text-white">Chi tiết</span>
                                         </button>
                                     </h3>
                                     
                                     <div class="flex flex-col gap-2 mb-8">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-bold text-blue-100 tracking-wide uppercase opacity-80">GPA (Hệ 4)</span>
                                            <span id="sim-label" class="hidden text-[10px] font-bold bg-white/20 px-2.5 py-1 rounded-md text-white animate-pulse border border-white/30 shadow-sm">DỰ KIẾN</span>
                                        </div>
                                        <div class="flex items-baseline gap-3 flex-wrap">
                                          <span id="stat-gpa4" class="text-5xl sm:text-7xl md:text-8xl font-black tracking-tighter drop-shadow-xl bg-gradient-to-b from-white via-white to-blue-200 bg-clip-text text-transparent py-2 pr-2 leading-none filter">0.00</span>
                                          
                                          <div id="sim-delta" class="hidden flex flex-col items-start ml-1 bg-black/20 rounded-xl px-3 py-1.5 backdrop-blur-md border border-white/10 shadow-lg">
                                              <span class="text-[10px] text-white/70 font-bold uppercase whitespace-nowrap mb-0.5">Thực tế: <span id="real-gpa-val" class="text-white">0.00</span></span>
                                              <span id="diff-val" class="text-base font-black text-green-300 drop-shadow-md leading-none">+0.00</span>
                                          </div>

                                          <span class="text-xl font-medium text-blue-200 ml-auto opacity-70">/ 4.0</span>
                                        </div>
                                     </div>

                                     <div class="grid grid-cols-2 gap-4 border-t border-white/20 pt-6">
                                        <div class="bg-white/10 rounded-3xl p-4 border border-white/10 backdrop-blur-md shadow-inner">
                                          <span class="mb-1 block text-[10px] font-bold text-blue-200 uppercase tracking-wider opacity-80">GPA (Hệ 10)</span>
                                          <span id="stat-gpa10" class="text-2xl sm:text-3xl font-bold tracking-tight">0.00</span>
                                        </div>
                                        <div class="bg-white/10 rounded-3xl p-4 border border-white/10 backdrop-blur-md shadow-inner">
                                          <span class="mb-1 block text-[10px] font-bold text-blue-200 uppercase tracking-wider opacity-80">Tổng tín chỉ</span>
                                          <span id="stat-credits" class="text-2xl sm:text-3xl font-bold tracking-tight">0</span>
                                        </div>
                                        <div class="col-span-2 mt-2">
                                          <div class="flex items-center justify-between bg-white/20 rounded-2xl px-5 py-4 border border-white/20 shadow-lg backdrop-blur-xl">
                                              <span class="text-xs font-bold text-blue-100 uppercase tracking-wide opacity-90">Xếp loại</span>
                                              <span id="stat-classification" class="text-base font-black text-white drop-shadow-md whitespace-nowrap tracking-wide">Chưa xếp loại</span>
                                          </div>
                                        </div>
                                     </div>
                                 </div>
                            </div>

                            <div class="glass-card rounded-[3rem] p-6 order-last">
                                <button onclick="toggleScale()" class="w-full text-center py-4 rounded-2xl bg-white/40 border border-white/50 hover:bg-white/60 text-base font-bold text-slate-800 hover:text-blue-600 transition-all shadow-sm active:scale-95">
                                    <span>Thang điểm tham khảo</span>
                                </button>
                                <div id="scale-table" class="hidden overflow-hidden pt-5">
                                    <table class="w-full text-xs">
                                        <thead>
                                            <tr class="border-b border-slate-200/50 text-slate-500">
                                                <th class="py-2.5 text-left pl-2">Điểm (10)</th>
                                                <th class="py-2.5 text-center">Chữ</th>
                                                <th class="py-2.5 text-right pr-2">Điểm (4)</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200/40">
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">9.0 - 10.0</td><td class="py-3 text-center"><span class="font-bold bg-green-100/80 text-green-700 px-2.5 py-1 rounded-md border border-green-200 shadow-sm">A</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">4.0</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">8.0 - 8.9</td><td class="py-3 text-center"><span class="font-bold bg-blue-100/80 text-blue-700 px-2.5 py-1 rounded-md border border-blue-200 shadow-sm">B+</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">3.5</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">7.0 - 7.9</td><td class="py-3 text-center"><span class="font-bold bg-cyan-100/80 text-cyan-700 px-2.5 py-1 rounded-md border border-cyan-200 shadow-sm">B</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">3.0</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">6.5 - 6.9</td><td class="py-3 text-center"><span class="font-bold bg-yellow-100/80 text-yellow-700 px-2.5 py-1 rounded-md border border-yellow-200 shadow-sm">C+</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">2.5</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">5.5 - 6.4</td><td class="py-3 text-center"><span class="font-bold bg-orange-100/80 text-orange-700 px-2.5 py-1 rounded-md border border-orange-200 shadow-sm">C</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">2.0</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">5.0 - 5.4</td><td class="py-3 text-center"><span class="font-bold bg-red-100/80 text-red-700 px-2.5 py-1 rounded-md border border-red-200 shadow-sm">D+</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">1.5</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">4.0 - 4.9</td><td class="py-3 text-center"><span class="font-bold bg-red-100/80 text-red-800 px-2.5 py-1 rounded-md border border-red-200 shadow-sm">D</span></td><td class="py-3 pr-3 text-right font-black text-blue-600">1.0</td></tr>
                                            <tr class="text-slate-700 hover:bg-white/40 table-row-anim"><td class="py-3 pl-3 font-medium">&lt; 4.0</td><td class="py-3 text-center"><span class="font-bold bg-slate-200/80 text-slate-600 px-2.5 py-1 rounded-md border border-slate-300 shadow-sm">F</span></td><td class="py-3 pr-3 text-right font-black text-slate-400">0.0</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-content-goal" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4 flex flex-col gap-6 glass-card p-8 rounded-[3rem] h-fit">
                            <h3 class="text-xl font-bold text-slate-800 border-b border-white/40 pb-5">Thông số đầu vào</h3>
                            <div class="flex flex-col gap-7">
                                <label class="flex flex-col w-full group opacity-75">
                                    <span class="text-slate-500 text-xs font-bold uppercase tracking-wider pb-2.5 flex items-center gap-2">
                                        <i data-lucide="history" class="h-4 w-4"></i> 
                                        GPA Hiện tại
                                        <span class="ml-auto text-[10px] bg-slate-100/60 px-2.5 py-0.5 rounded-lg text-slate-500 font-bold border border-slate-200">
                                          AUTO
                                        </span>
                                    </span>
                                    <input id="goal-current-gpa" type="text" readonly disabled class="glass-input h-14 w-full px-6 text-slate-500 font-bold outline-none bg-slate-50/40 cursor-not-allowed border-dashed">
                                </label>
                                
                                <label class="flex flex-col w-full group opacity-75">
                                    <span class="text-slate-500 text-xs font-bold uppercase tracking-wider pb-2.5 flex items-center gap-2">
                                        <i data-lucide="calculator" class="h-4 w-4"></i> 
                                        Tín chỉ tích lũy
                                        <span class="ml-auto text-[10px] bg-slate-100/60 px-2.5 py-0.5 rounded-lg text-slate-500 font-bold border border-slate-200">
                                          AUTO
                                        </span>
                                    </span>
                                    <input id="goal-accumulated-credits" type="text" readonly disabled class="glass-input h-14 w-full px-6 text-slate-500 font-bold outline-none bg-slate-50/40 cursor-not-allowed border-dashed">
                                </label>

                                <div class="h-px bg-gradient-to-r from-transparent via-slate-400/30 to-transparent my-2"></div>
                                
                                <label class="flex flex-col w-full group">
                                    <span class="text-blue-600 text-xs font-bold uppercase tracking-wider pb-2.5 flex items-center gap-2 transition-colors">
                                        <i data-lucide="target" class="h-4 w-4"></i> GPA Mục tiêu
                                    </span>
                                    <input id="goal-target-gpa" type="text" placeholder="Ví dụ: 3.6" inputmode="decimal" class="glass-input h-16 w-full px-6 text-slate-800 font-bold outline-none placeholder:text-slate-400 placeholder:font-normal focus:bg-white/90 text-lg">
                                </label>
                                <label class="flex flex-col w-full group">
                                    <span class="text-blue-600 text-xs font-bold uppercase tracking-wider pb-2.5 flex items-center gap-2 transition-colors">
                                        <i data-lucide="flag" class="h-4 w-4"></i> Tín chỉ mục tiêu
                                    </span>
                                    <input id="goal-target-credits" type="text" placeholder="Ví dụ: 30" inputmode="numeric" class="glass-input h-16 w-full px-6 text-slate-800 font-bold outline-none placeholder:text-slate-400 placeholder:font-normal focus:bg-white/90 text-lg">
                                </label>
                            </div>
                        </div>

                        <div class="lg:col-span-8 flex flex-col gap-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="glass-card p-8 rounded-[3rem] relative overflow-hidden group">
                                    <div id="blob-required" class="absolute -right-8 -top-8 h-48 w-48 rounded-full blur-3xl transition-all duration-700 bg-slate-400/20 group-hover:scale-110"></div>
                                    <div class="relative z-10">
                                        <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-3">Điểm TB cần đạt</p>
                                        <div class="flex items-baseline gap-2">
                                            <h2 id="goal-required-gpa" class="text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm text-slate-300 transition-colors">---</h2>
                                            <span class="text-lg font-bold text-slate-400">/ 4.0</span>
                                        </div>
                                        <div id="goal-possibility-badge" class="mt-8 hidden items-center gap-2.5 text-sm font-bold px-5 py-2.5 rounded-2xl w-fit backdrop-blur-md shadow-sm transition-all transform animate-enter"></div>
                                    </div>
                                </div>

                                <div class="glass-card p-8 rounded-[3rem] flex flex-col justify-between relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-40 h-40 bg-blue-500/5 rounded-bl-[4rem] pointer-events-none"></div>
                                    <div>
                                        <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-3">Cần tăng thêm</p>
                                        <div class="flex items-baseline gap-2">
                                             <h2 id="goal-diff" class="text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm text-slate-700">0.00</h2>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="mt-8 w-full bg-slate-200/50 h-5 rounded-full overflow-hidden border border-white/50 backdrop-blur-sm shadow-inner">
                                            <div id="goal-progress" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-1000 shadow-[0_0_20px_rgba(59,130,246,0.5)] relative" style="width: 0%">
                                                <div class="absolute inset-0 bg-white/30 animate-[shimmer_2s_infinite]"></div>
                                            </div>
                                        </div>
                                        <p id="goal-summary-text" class="mt-4 text-xs text-slate-500 font-medium pl-1">Nhập thông tin để xem kết quả</p>
                                    </div>
                                </div>
                            </div>

                            <div id="goal-chart-container" class="glass-card p-8 rounded-[3rem] flex flex-col hidden">
                                <div class="flex items-center justify-between mb-8">
                                    <h3 class="text-xl font-bold text-slate-800">Phân bổ điểm số đề xuất</h3>
                                </div>
                                
                                <div class="flex flex-col md:flex-row gap-12 items-center justify-center">
                                    <div class="h-64 w-64 relative filter drop-shadow-2xl">
                                        <canvas id="chart-canvas"></canvas>
                                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                            <span id="chart-center-val" class="text-6xl font-black text-slate-800 drop-shadow-sm">0</span>
                                            <span class="text-xs font-bold uppercase text-slate-500 mt-1">Tín chỉ</span>
                                        </div>
                                    </div>
                                    
                                    <div id="chart-legend" class="flex flex-col gap-4 w-full max-w-sm"></div>
                                </div>
                                
                                <div class="mt-10 p-6 rounded-3xl bg-gradient-to-r from-blue-500/10 via-blue-400/5 to-transparent border border-blue-500/20 flex items-start gap-5 shadow-inner backdrop-blur-sm">
                                    <div class="bg-blue-100/90 p-3 rounded-2xl shadow-sm text-blue-600">
                                        <i data-lucide="lightbulb" class="h-6 w-6 shrink-0"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-1.5">Lời khuyên chiến lược</p>
                                        <p id="goal-advice" class="text-sm text-slate-700 leading-relaxed font-medium"></p>
                                    </div>
                                </div>
                            </div>

                            <div id="goal-chart-empty" class="glass-card p-12 rounded-[3rem] flex flex-col items-center text-center">
                                <div class="h-28 w-28 bg-white/40 rounded-full flex items-center justify-center mb-6 border border-white/60 shadow-2xl backdrop-blur-md">
                                    <i data-lucide="pie-chart" class="h-12 w-12 text-slate-400/80"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800">Biểu đồ phân bổ điểm</h3>
                                <p class="text-slate-500 mt-3 max-w-sm text-sm font-medium">
                                    Nhập đầy đủ thông tin về GPA hiện tại và mục tiêu để xem phân tích phân bổ điểm số cần thiết.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <footer class="w-full flex justify-center pb-8 pt-4 z-10 relative">
             <div class="inline-flex items-center gap-1.5 px-5 py-2.5 rounded-full bg-white/20 border border-white/30 shadow-sm backdrop-blur-md transition-transform hover:scale-105 cursor-default group hover:bg-white/30">
                 <span class="text-[10px] font-bold text-slate-500/90 group-hover:text-slate-600 transition-colors uppercase tracking-wide">Thiết kế bởi</span>
                 <span class="text-[10px] font-black text-blue-600/90 tracking-wide group-hover:text-blue-700 transition-colors">gxrtohuuloi.logistics.ctu.edu.vn</span>
            </div>
        </footer>

        <div id="stats-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-xl transition-opacity duration-300" onclick="closeStatsModal()"></div>
            <div class="relative w-full max-w-3xl transform rounded-[3rem] bg-white/80 shadow-2xl transition-all animate-enter border border-white/60 backdrop-blur-3xl flex flex-col max-h-[90vh] ring-1 ring-white/50 overflow-hidden">
                
                <div class="flex items-center justify-between px-8 py-6 border-b border-slate-200/50 bg-white/40">
                     <div class="flex items-center gap-4">
                        <div class="p-2.5 bg-blue-500/10 rounded-2xl text-blue-600 shadow-sm">
                            <i data-lucide="bar-chart-2" class="h-6 w-6"></i>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">Chi tiết thống kê</h2>
                     </div>
                     <button onclick="closeStatsModal()" class="p-2.5 rounded-full hover:bg-slate-200/50 text-slate-500 transition-colors">
                         <i data-lucide="x" class="h-6 w-6"></i>
                     </button>
                </div>

                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    
                    <div class="mb-10">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-5 pl-2">Phân bố điểm số</h3>
                        <div class="h-72 w-full bg-white/40 rounded-[2rem] p-5 border border-white/60 shadow-inner">
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="grid grid-cols-2 gap-5 h-fit">
                            <div class="bg-white/50 p-5 rounded-[2rem] border border-white/60 shadow-sm flex flex-col items-center justify-center gap-1 hover:bg-white/80 transition-colors group">
                                <span class="text-3xl font-black text-slate-800 group-hover:scale-110 transition-transform" id="modal-total-subjects">0</span>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Tổng môn</span>
                            </div>
                            <div class="bg-green-50/60 p-5 rounded-[2rem] border border-green-100 shadow-sm flex flex-col items-center justify-center gap-1 hover:bg-green-50/80 transition-colors group">
                                <span class="text-3xl font-black text-green-600 group-hover:scale-110 transition-transform" id="modal-a-grades">0</span>
                                <span class="text-[10px] font-bold text-green-600/70 uppercase tracking-wider">Điểm A</span>
                            </div>
                            <div class="bg-blue-50/60 p-5 rounded-[2rem] border border-blue-100 shadow-sm flex flex-col items-center justify-center gap-1 hover:bg-blue-50/80 transition-colors group">
                                <span class="text-3xl font-black text-blue-600 group-hover:scale-110 transition-transform" id="modal-accumulated-credits">0</span>
                                <span class="text-[10px] font-bold text-blue-600/70 uppercase tracking-wider">TC Tích lũy</span>
                            </div>
                            <div class="bg-orange-50/60 p-5 rounded-[2rem] border border-orange-100 shadow-sm flex flex-col items-center justify-center gap-1 hover:bg-orange-50/80 transition-colors group">
                                <span class="text-3xl font-black text-orange-500 group-hover:scale-110 transition-transform" id="modal-highest-score">0</span>
                                <span class="text-[10px] font-bold text-orange-600/70 uppercase tracking-wider">Cao nhất</span>
                            </div>
                        </div>

                        <div>
                             <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-5 pl-2 text-center md:text-left">Tỷ lệ tích lũy</h3>
                             <div class="h-56 w-full flex items-center justify-center relative bg-white/30 rounded-[2rem] border border-white/40 shadow-sm p-4">
                                <canvas id="credits-chart"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-3xl font-black text-slate-700 drop-shadow-sm" id="modal-credit-percent">0%</span>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-slate-200/50 bg-white/40 backdrop-blur-md">
                    <button onclick="closeStatsModal()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-2xl font-bold shadow-lg shadow-blue-500/30 transition-all active:scale-[0.98]">
                        Đóng thống kê
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAmnmGjB_lb-xgZ6wSH5i7Y0QLOiUBXRxo",
          authDomain: "gxrtohuuloi-logistics.firebaseapp.com",
          projectId: "gxrtohuuloi-logistics",
          storageBucket: "gxrtohuuloi-logistics.firebasestorage.app",
          messagingSenderId: "894421141098",
          appId: "1:894421141098:web:7ff5e977e273998f95ac13"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let subjects = JSON.parse(localStorage.getItem('gpa-subjects') || '[]');
        
        // Immediate Migration for Local Data: Convert 'Hè' to 'HK3'
        let hasLocalMigration = false;
        subjects = subjects.map(s => {
            if (s.semester && s.semester.includes('Hè')) {
                hasLocalMigration = true;
                return { ...s, semester: s.semester.replace('Hè', 'HK3') };
            }
            return s;
        });
        if (hasLocalMigration) {
            localStorage.setItem('gpa-subjects', JSON.stringify(subjects));
        }

        let simulatedSubjects = [];
        let isSimulating = false;
        let newSubjectIsAccumulated = true;
        let chartInstance = null;
        let isSaving = false;
        let saveTimeout = null;
        let hasUnsavedChanges = false;
        let unsubscribe = null;
        let distChart = null;
        let creditChart = null;
        
        // Semesters Config - CHANGED: 'Hè' to 'HK3'
        const semesters = [
            "Năm 1 - HK1", "Năm 1 - HK2", "Năm 1 - HK3",
            "Năm 2 - HK1", "Năm 2 - HK2", "Năm 2 - HK3",
            "Năm 3 - HK1", "Năm 3 - HK2", "Năm 3 - HK3",
            "Năm 4 - HK1", "Năm 4 - HK2", "Năm 4 - HK3"
        ];

        // --- UTILS ---
        function getGradeInfo(score10) {
            score10 = parseFloat(score10);
            if (score10 >= 9.0) return { score4: 4.0, letter: 'A', colorClass: 'bg-green-100/80 text-green-700 ring-1 ring-green-200' };
            if (score10 >= 8.0) return { score4: 3.5, letter: 'B+', colorClass: 'bg-blue-100/80 text-blue-700 ring-1 ring-blue-200' };
            if (score10 >= 7.0) return { score4: 3.0, letter: 'B', colorClass: 'bg-cyan-100/80 text-cyan-700 ring-1 ring-cyan-200' };
            if (score10 >= 6.5) return { score4: 2.5, letter: 'C+', colorClass: 'bg-yellow-100/80 text-yellow-700 ring-1 ring-yellow-200' };
            if (score10 >= 5.5) return { score4: 2.0, letter: 'C', colorClass: 'bg-orange-100/80 text-orange-700 ring-1 ring-orange-200' };
            if (score10 >= 5.0) return { score4: 1.5, letter: 'D+', colorClass: 'bg-red-50/80 text-red-600 ring-1 ring-red-200' };
            if (score10 >= 4.0) return { score4: 1.0, letter: 'D', colorClass: 'bg-red-100/80 text-red-800 ring-1 ring-red-300' };
            return { score4: 0.0, letter: 'F', colorClass: 'bg-slate-200/80 text-slate-600 ring-1 ring-slate-300' };
        }

        function calculateGPA(subs) {
            const accumulatedSubjects = subs.filter(s => s.isAccumulated);
            const totalCredits = subs.reduce((sum, s) => sum + s.credits, 0);
            const gpaCredits = accumulatedSubjects.reduce((sum, s) => sum + s.credits, 0);
            
            if (gpaCredits === 0) return { gpa10: 0, gpa4: 0, totalCredits, gpaCredits: 0, classification: 'Chưa xếp loại' };

            const totalScore10 = accumulatedSubjects.reduce((sum, s) => sum + (s.score10 * s.credits), 0);
            const totalScore4 = accumulatedSubjects.reduce((sum, s) => sum + (getGradeInfo(s.score10).score4 * s.credits), 0);

            const gpa10 = totalScore10 / gpaCredits;
            const gpa4 = totalScore4 / gpaCredits;

            let classification = 'Kém';
            if (gpa4 >= 3.6) classification = 'Xuất sắc';
            else if (gpa4 >= 3.2) classification = 'Giỏi';
            else if (gpa4 >= 2.5) classification = 'Khá';
            else if (gpa4 >= 2.0) classification = 'Trung bình';
            else if (gpa4 >= 1.0) classification = 'Yếu';

            return { gpa10, gpa4, totalCredits, gpaCredits, classification };
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        function parseInputNumber(value) {
            if (!value) return 0;
            return parseFloat(value.toString().replace(/,/g, '.')) || 0;
        }
        function toTitleCase(str) {
            return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        // --- SIMULATION MODE LOGIC ---
        function toggleSimulation() {
            isSimulating = !isSimulating;
            const toggle = document.getElementById('sim-toggle');
            const listCard = document.getElementById('list-card');
            const simBadge = document.getElementById('sim-badge');
            const statsBg = document.getElementById('stats-bg');
            const btnAdd = document.getElementById('btn-add-main');
            const btnDeleteAll = document.getElementById('btn-delete-all');
            const simLabel = document.getElementById('sim-label');
            const simDelta = document.getElementById('sim-delta');

            if (isSimulating) {
                // Activate Sim Mode
                
                // Smart Sync:
                // Create a cache of current simulated values (ID -> {score, accumulated})
                const simCache = {};
                simulatedSubjects.forEach(s => {
                    simCache[s.id] = { score10: s.score10, isAccumulated: s.isAccumulated };
                });

                // Re-build simulatedSubjects based on current REAL subjects
                // This ensures new subjects added in normal mode appear, and deleted ones are removed
                // BUT scores are preserved from simulation memory if they exist
                simulatedSubjects = subjects.map(realSub => {
                    const cached = simCache[realSub.id];
                    if (cached) {
                        // Subject exists in both, use Real metadata (Name/Credits) but Sim data (Score/Accumulate)
                        return {
                            ...realSub,
                            score10: cached.score10,
                            isAccumulated: cached.isAccumulated
                        };
                    }
                    // New subject in real mode, just copy it over for the first time
                    return JSON.parse(JSON.stringify(realSub));
                });

                document.body.classList.add('sim-mode-active');
                simBadge.classList.remove('hidden');
                simLabel.classList.remove('hidden');
                simDelta.classList.remove('hidden');
                
                // Visual cues
                statsBg.classList.remove('from-blue-600/90', 'via-indigo-600/90', 'to-purple-600/90');
                statsBg.classList.add('from-purple-600/90', 'via-fuchsia-600/90', 'to-indigo-600/90');
                
                // Disable Add/Delete functionality to simplify "What-if" to editing only
                btnAdd.disabled = true;
                btnAdd.classList.add('opacity-50', 'cursor-not-allowed');
                btnDeleteAll.disabled = true;
                btnDeleteAll.classList.add('opacity-50', 'cursor-not-allowed');

            } else {
                // Deactivate Sim Mode
                document.body.classList.remove('sim-mode-active');
                simBadge.classList.add('hidden');
                simLabel.classList.add('hidden');
                simDelta.classList.add('hidden');
                
                statsBg.classList.add('from-blue-600/90', 'via-indigo-600/90', 'to-purple-600/90');
                statsBg.classList.remove('from-purple-600/90', 'via-fuchsia-600/90', 'to-indigo-600/90');

                btnAdd.disabled = false;
                btnAdd.classList.remove('opacity-50', 'cursor-not-allowed');
                btnDeleteAll.disabled = false;
                btnDeleteAll.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            renderSubjectList();
            updateStats();
        }

        function updateSimulatedScore(id, newScoreStr) {
            const newScore = parseInputNumber(newScoreStr);
            if (newScore < 0 || newScore > 10) return;

            simulatedSubjects = simulatedSubjects.map(s => {
                if(s.id === id) return {...s, score10: newScore};
                return s;
            });
            updateStats(); // Re-calc stats locally
            // Actually, let's update the Grade 4/Letter cell next to input immediately
            const row = document.getElementById(`row-${id}`);
            if(row) {
                const grade = getGradeInfo(newScore);
                const score4Cell = row.querySelector('.score4-cell');
                const letterCell = row.querySelector('.letter-cell span');
                if(score4Cell) score4Cell.innerText = formatNumber(grade.score4, 1);
                if(letterCell) {
                    letterCell.innerText = grade.letter;
                    letterCell.className = `inline-flex items-center rounded-lg px-2.5 py-1 text-xs font-bold shadow-sm ${grade.colorClass}`;
                }
            }
        }

        // --- CORE FUNCTIONS ---

        function handleStudentIdChange(val) {
            const upper = val.trim().toUpperCase();
            document.getElementById('student-id').value = upper;
            localStorage.setItem('gpa-student-id', upper);
            if (unsubscribe) { unsubscribe(); unsubscribe = null; }
            if (upper.length < 3) {
                updateStatus("Chưa kết nối", "normal");
                return;
            }
            setupRealtimeListener(upper);
        }

        function setupRealtimeListener(studentId) {
            // Skeleton ON
            const skeleton = document.getElementById('loading-skeleton');
            const content = document.getElementById('main-content');
            
            skeleton.classList.remove('hidden');
            content.classList.add('hidden');
            
            updateStatus("Đang kết nối...", "loading");

            const docRef = doc(db, "students", studentId);

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                // Skeleton OFF
                skeleton.classList.add('hidden');
                content.classList.remove('hidden');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let fetchedSubjects = data.subjects || [];

                    // --- MIGRATION LOGIC: 'Hè' -> 'HK3' ---
                    let hasDbMigration = false;
                    fetchedSubjects = fetchedSubjects.map(s => {
                        if (s.semester && s.semester.includes('Hè')) {
                            hasDbMigration = true;
                            return { ...s, semester: s.semester.replace('Hè', 'HK3') };
                        }
                        return s;
                    });
                    
                    subjects = fetchedSubjects;

                    if (data.goal) {
                        const tGPA = data.goal.targetGPA || '';
                        const tCred = data.goal.targetCredits || '';
                        document.getElementById('goal-target-gpa').value = tGPA;
                        document.getElementById('goal-target-credits').value = tCred;
                        localStorage.setItem('gpa-target-gpa', tGPA);
                        localStorage.setItem('gpa-target-credits', tCred);
                    }
                    
                    saveSubjectsLocal();
                    if(!isSimulating) renderSubjectList(false);
                    updateStats();
                    const stats = calculateGPA(subjects);
                    document.getElementById('goal-current-gpa').value = formatNumber(stats.gpa4);
                    document.getElementById('goal-accumulated-credits').value = stats.gpaCredits; 
                    calculateGoal();

                    updateStatus("Đã đồng bộ", "success");
                    hasUnsavedChanges = false;

                    // Trigger save to persist migration if needed
                    if (hasDbMigration && !isSaving) {
                        triggerAutoSave();
                    }

                } else {
                    if (!isSaving) {
                        subjects = [];
                        if(!isSimulating) renderSubjectList(false);
                        updateStats();
                        updateStatus("Sẵn sàng", "normal");
                    }
                }
            }, (error) => {
                console.error("Firestore Error:", error);
                skeleton.classList.add('hidden');
                content.classList.remove('hidden');
                updateStatus("Lỗi kết nối", "error");
            });
        }
        
        function updateStatus(msg, type = 'normal') {
            const badgeTextEl = document.getElementById('save-status-text');
            const dotEl = document.getElementById('status-dot');
            let shortText = 'OFFLINE', colorClass = 'text-slate-400', dotClass = 'bg-slate-400';

            if (type === 'success') { shortText = 'ONLINE'; colorClass = 'text-green-600'; dotClass = 'bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]'; }
            else if (type === 'error') { shortText = 'LỖI'; colorClass = 'text-red-500'; dotClass = 'bg-red-500'; }
            else if (type === 'saving') { shortText = 'ĐANG LƯU'; colorClass = 'text-blue-500'; dotClass = 'bg-blue-500 status-pulse'; }
            else if (type === 'loading') { shortText = 'ĐANG TẢI'; colorClass = 'text-blue-500'; dotClass = 'bg-blue-500 animate-bounce'; }
            else if (type === 'unsaved') { shortText = 'CHƯA LƯU'; colorClass = 'text-orange-500'; dotClass = 'bg-orange-400'; }

            if(badgeTextEl) { badgeTextEl.innerText = shortText; badgeTextEl.className = `text-[10px] font-bold uppercase tracking-wider ${colorClass}`; }
            if(dotEl) { dotEl.className = `absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-white ${dotClass}`; }
        }

        function triggerAutoSave() {
            if(isSimulating) return; // Never save in Sim mode
            hasUnsavedChanges = true;
            updateStatus("Đang chờ lưu...", "unsaved");
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { performAutoSave(); }, 2000);
        }

        async function performAutoSave() {
            let studentId = document.getElementById('student-id').value.trim().toUpperCase();
            if(!studentId) return;
            isSaving = true;
            updateStatus("Đang đồng bộ...", "saving");
            const targetGPA = document.getElementById('goal-target-gpa').value;
            const targetCredits = document.getElementById('goal-target-credits').value;

            try {
                await setDoc(doc(db, "students", studentId), {
                    subjects: subjects,
                    goal: { targetGPA, targetCredits },
                    lastUpdated: new Date().toISOString()
                });
                hasUnsavedChanges = false;
            } catch (e) {
                console.error("Save error:", e);
                updateStatus("Lỗi lưu trữ", "error");
            } finally { isSaving = false; }
        }

        // --- TAB & UI LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            // Populate Semester Dropdown
            const semSelect = document.getElementById('input-semester');
            semesters.forEach(sem => {
                const opt = document.createElement('option');
                opt.value = sem;
                opt.text = sem;
                semSelect.appendChild(opt);
            });

            renderSubjectList(false);
            updateStats();
            initGoalPlanner();
            lucide.createIcons();
            
            const savedId = localStorage.getItem('gpa-student-id');
            if(savedId) {
                document.getElementById('student-id').value = savedId;
                if(savedId.length > 2) setupRealtimeListener(savedId);
            }
            
            document.getElementById('input-name').addEventListener('input', function(e) {
                if (this.value !== toTitleCase(this.value)) {
                    const start = this.selectionStart; const end = this.selectionEnd;
                    this.value = toTitleCase(this.value); this.setSelectionRange(start, end);
                }
            });
        });

        function switchTab(tab) {
            const tabCalc = document.getElementById('tab-content-calculator');
            const tabGoal = document.getElementById('tab-content-goal');
            const navCalc = document.getElementById('nav-calculator');
            const navGoal = document.getElementById('nav-goal');
            
            if (tab === 'calculator') {
                if (tabCalc.classList.contains('hidden')) {
                    tabGoal.classList.add('hidden');
                    tabCalc.classList.remove('hidden');
                    tabCalc.classList.remove('animate-fade-up', 'animate-slide-right');
                    tabCalc.classList.add('animate-slide-left');
                }
                navCalc.className = "flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 bg-white shadow-md text-blue-600 ring-1 ring-black/5";
                navGoal.className = "flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 text-slate-500 hover:text-slate-800 hover:bg-white/40";
            } else {
                if (tabGoal.classList.contains('hidden')) {
                    tabCalc.classList.add('hidden');
                    tabGoal.classList.remove('hidden');
                    tabGoal.classList.remove('animate-fade-up', 'animate-slide-left');
                    tabGoal.classList.add('animate-slide-right');
                    
                    const stats = calculateGPA(subjects);
                    document.getElementById('goal-current-gpa').value = formatNumber(stats.gpa4);
                    document.getElementById('goal-accumulated-credits').value = stats.gpaCredits; 
                    calculateGoal(); 
                }
                navCalc.className = "flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 text-slate-500 hover:text-slate-800 hover:bg-white/40";
                navGoal.className = "flex-1 md:flex-none relative z-10 rounded-full px-6 py-2.5 text-sm font-bold transition-all duration-300 bg-white shadow-md text-blue-600 ring-1 ring-black/5";
            }
        }

        function toggleNewAccumulate() {
            newSubjectIsAccumulated = !newSubjectIsAccumulated;
            const btn = document.getElementById('btn-accumulate');
            if (newSubjectIsAccumulated) {
                btn.className = "glass-button-secondary flex items-center gap-2.5 h-14 px-6 active:scale-95 transition-all bg-blue-50/50 border-blue-200 text-blue-600 shadow-inner";
                btn.innerHTML = '<i data-lucide="check-circle-2" class="h-5 w-5 shrink-0"></i><span class="text-sm font-bold whitespace-nowrap">Tích lũy</span>';
            } else {
                btn.className = "glass-button-secondary flex items-center gap-2.5 h-14 px-6 active:scale-95 transition-all opacity-70";
                btn.innerHTML = '<i data-lucide="circle" class="h-5 w-5 shrink-0"></i><span class="text-sm font-bold whitespace-nowrap">Tích lũy</span>';
            }
            lucide.createIcons();
        }

        function addSubject() {
            if(isSimulating) return alert("Vui lòng tắt chế độ Dự tính để thêm môn học.");

            const name = document.getElementById('input-name').value.trim();
            const semester = document.getElementById('input-semester').value;
            const credits = parseInt(document.getElementById('input-credits').value);
            
            // CHANGED: Get raw value to check for 2 digit input (e.g. 98)
            let scoreVal = document.getElementById('input-score').value;
            let score10 = parseInputNumber(scoreVal);
            
            // CHANGED: Logic to convert 98 -> 9.8 (if score > 10 and < 100)
            if (score10 > 10 && score10 < 100) {
                score10 = score10 / 10;
            }

            if (!name || isNaN(score10)) return;
            if (isNaN(credits) || credits < 1 || credits > 10) return alert("Số tín chỉ phải từ 1 đến 10");
            if (score10 < 0 || score10 > 10) return alert("Điểm phải từ 0-10");

            const normalizedName = name.toLowerCase();
            const existingIndex = subjects.findIndex(s => s.name.toLowerCase() === normalizedName);
            if (existingIndex !== -1) {
                if (confirm(`Môn "${toTitleCase(name)}" đã tồn tại. Thay thế?`)) subjects.splice(existingIndex, 1);
                else return;
            }

            subjects.push({
                id: Date.now().toString(),
                name: toTitleCase(name),
                semester: semester || "Chưa phân loại",
                credits, score10, isAccumulated: newSubjectIsAccumulated
            });

            saveSubjectsLocal();
            renderSubjectList(true);
            updateStats();
            triggerAutoSave();
            
            document.getElementById('input-name').value = '';
            document.getElementById('input-score').value = '';
            document.getElementById('input-credits').value = '';
            document.getElementById('input-name').focus();
        }

        function deleteSubject(id) {
            if(isSimulating) return;
            subjects = subjects.filter(s => s.id !== id);
            saveSubjectsLocal();
            renderSubjectList(false);
            updateStats();
            triggerAutoSave();
        }

        function toggleSubjectAccumulate(id) {
            if(isSimulating) {
                simulatedSubjects = simulatedSubjects.map(s => s.id === id ? { ...s, isAccumulated: !s.isAccumulated } : s);
            } else {
                subjects = subjects.map(s => s.id === id ? { ...s, isAccumulated: !s.isAccumulated } : s);
                saveSubjectsLocal();
                triggerAutoSave();
            }
            renderSubjectList(false);
            updateStats();
        }

        function deleteAllSubjects() {
            if(isSimulating) return;
            if (confirm("Xóa tất cả?")) {
                subjects = [];
                saveSubjectsLocal();
                renderSubjectList(false);
                updateStats();
                triggerAutoSave();
            }
        }

        function saveSubjectsLocal() { localStorage.setItem('gpa-subjects', JSON.stringify(subjects)); }

        function renderSubjectList(animateLast = false) {
            const tbody = document.getElementById('subject-list');
            const dataToRender = isSimulating ? simulatedSubjects : subjects;
            
            if (dataToRender.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="py-12 text-center text-slate-500 italic font-medium">Chưa có môn học nào.</td></tr>`;
                return;
            }

            // Group by Semester
            const grouped = dataToRender.reduce((acc, sub) => {
                const sem = sub.semester || "Chưa phân loại";
                if(!acc[sem]) acc[sem] = [];
                acc[sem].push(sub);
                return acc;
            }, {});

            // Sort semesters order based on config array index
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const idxA = semesters.indexOf(a);
                const idxB = semesters.indexOf(b);
                // If not in list, put at bottom
                if(idxA === -1) return 1;
                if(idxB === -1) return -1;
                return idxA - idxB;
            });

            let html = '';
            let globalIndex = 0;

            sortedKeys.forEach(sem => {
                const groupSubs = grouped[sem];
                const groupStats = calculateGPA(groupSubs);
                
                // Semester Header - REVISED: Liquid glass bubbles, rounded corners, stats next to title
                html += `
                    <tr class="border-b border-transparent">
                        <td colspan="8" class="pt-8 pb-3 px-2 sm:px-4">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                                <div class="glass-card px-5 py-2.5 rounded-2xl border border-blue-200/50 bg-blue-50/30 backdrop-blur-md shadow-sm w-fit">
                                    <span class="text-xs font-black uppercase tracking-widest text-blue-600 drop-shadow-sm whitespace-nowrap">${sem}</span>
                                </div>
                                
                                <div class="flex items-center gap-2 sm:gap-3 flex-wrap">
                                     <div class="glass-card px-3.5 py-1.5 rounded-xl border border-white/60 bg-white/50 backdrop-blur-md flex items-center gap-2 shadow-sm hover:scale-105 transition-transform cursor-default group/stat">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider group-hover/stat:text-blue-500 transition-colors">GPA</span>
                                        <span class="text-sm font-black text-blue-600">${formatNumber(groupStats.gpa4)}</span>
                                    </div>
                                    <div class="glass-card px-3.5 py-1.5 rounded-xl border border-white/60 bg-white/50 backdrop-blur-md flex items-center gap-2 shadow-sm hover:scale-105 transition-transform cursor-default group/stat">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider group-hover/stat:text-blue-500 transition-colors">TB</span>
                                        <span class="text-sm font-bold text-slate-700">${formatNumber(groupStats.gpa10)}</span>
                                    </div>
                                    <div class="glass-card px-3.5 py-1.5 rounded-xl border border-white/60 bg-white/50 backdrop-blur-md flex items-center gap-2 shadow-sm hover:scale-105 transition-transform cursor-default group/stat">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider group-hover/stat:text-blue-500 transition-colors">TC</span>
                                        <span class="text-sm font-bold text-slate-700">${groupStats.totalCredits}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;

                groupSubs.forEach((subject) => {
                    globalIndex++;
                    const grade = getGradeInfo(subject.score10);
                    const opacityClass = subject.isAccumulated ? '' : 'opacity-40 grayscale';
                    const accIcon = subject.isAccumulated 
                        ? `<i data-lucide="check-circle-2" class="h-5 w-5 ${isSimulating ? 'text-purple-500' : 'text-green-500'} drop-shadow-sm"></i>` 
                        : `<i data-lucide="circle" class="h-5 w-5"></i>`;
                    
                    // Input vs Text for Score column
                    const scoreCellContent = isSimulating 
                        ? `<input type="number" value="${subject.score10}" min="0" max="10" step="0.1" 
                             class="sim-input" 
                             oninput="updateSimulatedScore('${subject.id}', this.value)">`
                        : `<span class="font-bold text-slate-700">${subject.score10}</span>`;

                    const deleteBtn = isSimulating 
                        ? `` // No delete in Sim mode
                        : `<button onclick="deleteSubject('${subject.id}')" class="rounded-xl p-2.5 text-slate-400 transition-all hover:bg-red-100 hover:text-red-500 hover:shadow-sm hover:scale-105"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`;

                    html += `
                    <tr id="row-${subject.id}" class="group transition-all hover:bg-white/40 ${opacityClass} border-b border-transparent hover:border-white/50 table-row-anim rounded-2xl">
                        <td class="px-5 py-4 text-sm text-slate-500 font-bold opacity-60 hidden sm:table-cell pl-8">${globalIndex}</td>
                        <td class="px-5 py-4 text-sm font-semibold text-slate-800 whitespace-normal md:whitespace-nowrap min-w-[120px]" title="${subject.name}">${subject.name}</td>
                        <td class="px-5 py-4 text-center text-sm text-slate-600 font-medium">${subject.credits}</td>
                        <td class="px-5 py-4 text-center">
                            <button onclick="toggleSubjectAccumulate('${subject.id}')" class="text-slate-400 hover:text-blue-500 transition-colors p-1.5 transform active:scale-90 hover:bg-white/50 rounded-full">
                                ${accIcon}
                            </button>
                        </td>
                        <td class="px-5 py-4 text-center text-sm">${scoreCellContent}</td>
                        <td class="px-5 py-4 text-center text-sm font-black ${isSimulating ? 'text-purple-600' : 'text-blue-600'} drop-shadow-sm score4-cell">${formatNumber(grade.score4, 1)}</td>
                        <td class="px-5 py-4 text-center letter-cell">
                            <span class="inline-flex items-center rounded-lg px-3 py-1 text-xs font-bold shadow-sm ${grade.colorClass}">
                                ${grade.letter}
                            </span>
                        </td>
                        <td class="px-5 py-4 text-right pr-8">${deleteBtn}</td>
                    </tr>
                    `;
                });
            });

            tbody.innerHTML = html;
            lucide.createIcons();
        }

        function updateStats() {
            const realStats = calculateGPA(subjects);
            const currentStats = calculateGPA(isSimulating ? simulatedSubjects : subjects);
            
            document.getElementById('stat-gpa4').innerText = formatNumber(currentStats.gpa4);
            document.getElementById('stat-gpa10').innerText = formatNumber(currentStats.gpa10);
            document.getElementById('stat-credits').innerText = currentStats.totalCredits;
            document.getElementById('stat-classification').innerText = currentStats.classification;

            // Handle Sim Delta
            if(isSimulating) {
                const diff = currentStats.gpa4 - realStats.gpa4;
                const sign = diff > 0 ? '+' : '';
                const diffEl = document.getElementById('diff-val');
                const realGpaEl = document.getElementById('real-gpa-val');
                
                realGpaEl.innerText = formatNumber(realStats.gpa4);
                diffEl.innerText = `${sign}${formatNumber(diff)}`;
                diffEl.className = `text-base font-black drop-shadow-sm leading-none ${diff >= 0 ? 'text-green-300' : 'text-red-300'}`;
            }
        }

        function toggleScale() {
            const scaleDiv = document.getElementById('scale-table');
            if (scaleDiv.classList.contains('hidden')) {
                scaleDiv.classList.remove('hidden');
                scaleDiv.classList.add('animate-enter'); 
            } else {
                scaleDiv.classList.add('hidden');
                scaleDiv.classList.remove('animate-enter');
            }
        }

        function openStatsModal() {
            document.getElementById('stats-modal').classList.remove('hidden');
            document.getElementById('stats-modal').classList.add('flex');
            renderDetailCharts();
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').classList.add('hidden');
            document.getElementById('stats-modal').classList.remove('flex');
        }

        function renderDetailCharts() {
            const grades = { 'A': 0, 'B+': 0, 'B': 0, 'C+': 0, 'C': 0, 'D+': 0, 'D': 0, 'F': 0 };
            let aGrades = 0;
            let accCredits = 0;
            let highestScore = 0;

            const data = isSimulating ? simulatedSubjects : subjects;

            data.forEach(s => {
                const info = getGradeInfo(s.score10);
                if (grades[info.letter] !== undefined) grades[info.letter]++;
                if (info.letter === 'A') aGrades++;
                if (s.isAccumulated) accCredits += s.credits;
                if (s.score10 > highestScore) highestScore = s.score10;
            });

            const totalCredits = data.reduce((sum, s) => sum + s.credits, 0);
            const nonAccCredits = totalCredits - accCredits;
            const percentAcc = totalCredits > 0 ? Math.round((accCredits / totalCredits) * 100) : 0;

            document.getElementById('modal-total-subjects').innerText = data.length;
            document.getElementById('modal-a-grades').innerText = aGrades;
            document.getElementById('modal-accumulated-credits').innerText = accCredits;
            document.getElementById('modal-highest-score').innerText = highestScore;
            document.getElementById('modal-credit-percent').innerText = percentAcc + "%";

            // Chart Config - Improved Look
            Chart.defaults.font.family = "'Lexend', sans-serif";
            Chart.defaults.color = '#64748b';

            const ctxDist = document.getElementById('grade-distribution-chart').getContext('2d');
            if (distChart) distChart.destroy();
            
            // Gradient for bars
            const gradientA = ctxDist.createLinearGradient(0, 0, 0, 300);
            gradientA.addColorStop(0, 'rgba(74, 222, 128, 0.8)');
            gradientA.addColorStop(1, 'rgba(74, 222, 128, 0.2)');

            const gradientRest = ctxDist.createLinearGradient(0, 0, 0, 300);
            gradientRest.addColorStop(0, 'rgba(96, 165, 250, 0.8)');
            gradientRest.addColorStop(1, 'rgba(96, 165, 250, 0.2)');

            distChart = new Chart(ctxDist, {
                type: 'bar',
                data: {
                    labels: Object.keys(grades),
                    datasets: [{
                        label: 'Số lượng môn',
                        data: Object.values(grades),
                        backgroundColor: (ctx) => {
                            if (ctx.dataIndex === 0) return gradientA;
                            return gradientRest;
                        },
                        borderRadius: 12,
                        borderSkipped: false,
                        maxBarThickness: 45,
                        hoverBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#1e293b',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 14 },
                            cornerRadius: 12
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f1f5f9', drawBorder: false },
                            ticks: { precision: 0 }
                        }, 
                        x: { 
                            grid: { display: false, drawBorder: false } 
                        } 
                    }
                }
            });

            const ctxCredit = document.getElementById('credits-chart').getContext('2d');
            if (creditChart) creditChart.destroy();
            creditChart = new Chart(ctxCredit, {
                type: 'doughnut',
                data: {
                    labels: ['Tích lũy', 'Không tích lũy'],
                    datasets: [{
                        data: [accCredits, nonAccCredits],
                        backgroundColor: ['#3b82f6', '#f1f5f9'],
                        borderWidth: 0,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '82%',
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // --- GOAL PLANNER ---
        function initGoalPlanner() {
            const savedGpa = localStorage.getItem('gpa-target-gpa') || '';
            const savedCredits = localStorage.getItem('gpa-target-credits') || '';
            document.getElementById('goal-target-gpa').value = savedGpa;
            document.getElementById('goal-target-credits').value = savedCredits;

            ['goal-target-gpa', 'goal-target-credits'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    localStorage.setItem(id === 'goal-target-gpa' ? 'gpa-target-gpa' : 'gpa-target-credits', document.getElementById(id).value);
                    calculateGoal();
                    triggerAutoSave();
                });
            });
        }

        function calculateGoal() {
            const currentGPA = parseInputNumber(document.getElementById('goal-current-gpa').value);
            const accumulatedCredits = parseInputNumber(document.getElementById('goal-accumulated-credits').value);
            const targetGPA = parseInputNumber(document.getElementById('goal-target-gpa').value);
            const targetCredits = parseInputNumber(document.getElementById('goal-target-credits').value);

            const totalTargetPoints = targetGPA * (accumulatedCredits + targetCredits);
            const currentPoints = currentGPA * accumulatedCredits;
            const requiredPoints = totalTargetPoints - currentPoints;
            const requiredGPA = targetCredits > 0 ? requiredPoints / targetCredits : 0;
            const gpaDiff = targetGPA - currentGPA;
            
            // Check feasibility roughly
            const isPossible = targetCredits > 0 ? (requiredGPA <= 4.0 && requiredGPA >= 0) : (currentGPA >= targetGPA);
            const progressPercent = Math.min(100, Math.max(0, ((currentGPA) / 4) * 100));

            const reqEl = document.getElementById('goal-required-gpa');
            const blobEl = document.getElementById('blob-required');
            const badgeEl = document.getElementById('goal-possibility-badge');
            
            reqEl.innerText = targetCredits > 0 ? formatNumber(requiredGPA) : '---';
            
            if (targetCredits > 0) {
                 if (requiredGPA > 4.0) {
                     reqEl.className = `text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm transition-colors text-red-500`;
                     blobEl.className = `absolute -right-8 -top-8 h-48 w-48 rounded-full blur-3xl transition-all duration-700 group-hover:scale-110 bg-red-400/30`;
                     badgeEl.classList.remove('hidden');
                     badgeEl.classList.add('flex');
                     badgeEl.className = "mt-8 flex items-center gap-2.5 text-red-700 text-sm font-bold bg-red-500/10 border border-red-500/20 px-5 py-2.5 rounded-2xl w-fit backdrop-blur-md shadow-sm";
                     badgeEl.innerHTML = `<i data-lucide="alert-triangle" class="h-4 w-4"></i> Không khả thi (>4.0)`;
                 } else if (requiredGPA < 0) {
                     // Already achieved practically
                     reqEl.className = `text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm transition-colors text-green-600`;
                     blobEl.className = `absolute -right-8 -top-8 h-48 w-48 rounded-full blur-3xl transition-all duration-700 group-hover:scale-110 bg-green-400/30`;
                     badgeEl.classList.remove('hidden');
                     badgeEl.classList.add('flex');
                     badgeEl.className = "mt-8 flex items-center gap-2.5 text-green-700 text-sm font-bold bg-green-500/10 border border-green-500/20 px-5 py-2.5 rounded-2xl w-fit backdrop-blur-md shadow-sm";
                     badgeEl.innerHTML = `<i data-lucide="check-circle" class="h-4 w-4"></i> Đã đạt`;
                 } else {
                     reqEl.className = `text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm transition-colors ${requiredGPA > 3.2 ? 'text-slate-700' : 'text-green-600'}`;
                     blobEl.className = `absolute -right-8 -top-8 h-48 w-48 rounded-full blur-3xl transition-all duration-700 group-hover:scale-110 ${requiredGPA > 3.2 ? 'bg-slate-400/20' : 'bg-green-400/20'}`;
                     
                     badgeEl.classList.remove('hidden');
                     badgeEl.classList.add('flex');
                     badgeEl.className = "mt-8 flex items-center gap-2.5 text-green-700 text-sm font-bold bg-green-500/10 border border-green-500/20 px-5 py-2.5 rounded-2xl w-fit backdrop-blur-md shadow-sm";
                     badgeEl.innerHTML = `<i data-lucide="check-circle" class="h-4 w-4"></i> Khả thi`;
                 }
            } else {
                 reqEl.className = `text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm text-slate-300`;
                 blobEl.className = "absolute -right-8 -top-8 h-48 w-48 rounded-full blur-3xl transition-all duration-700 bg-slate-400/20";
                 badgeEl.classList.add('hidden');
                 badgeEl.classList.remove('flex');
            }

            const diffEl = document.getElementById('goal-diff');
            diffEl.innerText = (gpaDiff > 0 ? '+' : '') + formatNumber(gpaDiff);
            diffEl.className = `text-5xl sm:text-7xl font-black tracking-tighter drop-shadow-sm ${gpaDiff > 0 ? 'text-blue-600' : 'text-slate-700'}`;
            
            document.getElementById('goal-progress').style.width = `${progressPercent}%`;
            document.getElementById('goal-summary-text').innerHTML = `Từ <span class="text-slate-900 font-bold">${formatNumber(currentGPA)}</span> lên <span class="text-slate-900 font-bold">${formatNumber(targetGPA)}</span> với ${targetCredits} tín chỉ mục tiêu`;

            renderGoalChart(targetCredits, requiredGPA);
            lucide.createIcons();
        }

        function renderGoalChart(targetCredits, requiredGPA) {
            const chartContainer = document.getElementById('goal-chart-container');
            const emptyContainer = document.getElementById('goal-chart-empty');
            
            if (targetCredits <= 0) {
                chartContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }

            chartContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');

            let pieData = [], colors = [], labels = [], advice = "";

            if (requiredGPA > 4.0) {
                pieData = [targetCredits];
                colors = ['#ef4444'];
                labels = ['Không khả thi'];
                advice = `GPA cần đạt ${formatNumber(requiredGPA)} > 4.0. Hãy điều chỉnh mục tiêu.`;
            } else if (requiredGPA < 0) {
                pieData = [targetCredits];
                colors = ['#22c55e'];
                labels = ['Đã đạt'];
                advice = `Bạn đã đạt mục tiêu.`;
            } else {
                if (requiredGPA >= 3.8) {
                    pieData = [targetCredits * 0.9, targetCredits * 0.1];
                    colors = ['#2563eb', '#60a5fa'];
                    labels = ['Điểm A', 'Điểm B+'];
                    advice = `Cần nỗ lực rất cao, chủ yếu là điểm A để đạt mục tiêu này.`;
                } else if (requiredGPA >= 3.2) {
                    pieData = [targetCredits * 0.5, targetCredits * 0.3, targetCredits * 0.2];
                    colors = ['#2563eb', '#60a5fa', '#cbd5e1'];
                    labels = ['A', 'B+', 'B'];
                    advice = `Cần duy trì sức học Khá - Giỏi, hạn chế điểm C.`;
                } else {
                    pieData = [targetCredits * 0.4, targetCredits * 0.6];
                    colors = ['#60a5fa', '#cbd5e1'];
                    labels = ['B+', 'B'];
                    advice = `Mục tiêu trong tầm tay, chỉ cần duy trì phong độ hiện tại.`;
                }
            }

            document.getElementById('goal-advice').innerText = advice;
            document.getElementById('chart-center-val').innerText = targetCredits;

            const legendDiv = document.getElementById('chart-legend');
            let legendHtml = '';
            pieData.forEach((val, i) => {
                legendHtml += `
                <div class="flex items-center justify-between p-4 rounded-2xl bg-white/40 border border-white/50 shadow-sm transition-colors hover:bg-white/60">
                    <div class="flex items-center gap-3">
                        <div class="h-3.5 w-3.5 rounded-full shadow-sm ring-2 ring-white" style="background-color: ${colors[i]}"></div>
                        <div><p class="text-sm font-bold text-slate-700">${labels[i]}</p></div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-slate-900">${Math.round(val)} TC</p>
                    </div>
                </div>`;
            });
            legendDiv.innerHTML = legendHtml;

            const ctx = document.getElementById('chart-canvas').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 12,
                        offset: 6
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }
        
        // Expose functions globally
        window.switchTab = switchTab;
        window.toggleNewAccumulate = toggleNewAccumulate;
        window.addSubject = addSubject;
        window.deleteSubject = deleteSubject;
        window.toggleSubjectAccumulate = toggleSubjectAccumulate;
        window.deleteAllSubjects = deleteAllSubjects;
        window.toggleScale = toggleScale;
        window.handleStudentIdChange = handleStudentIdChange;
        window.openStatsModal = openStatsModal;
        window.closeStatsModal = closeStatsModal;
        window.toggleSimulation = toggleSimulation;
        window.updateSimulatedScore = updateSimulatedScore;
        window.calculateGoal = calculateGoal;
        window.initGoalPlanner = initGoalPlanner;
    </script>
</body>
</html>